<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PARAM SSH Manager</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Clean Black, White & Dark Blue Palette */
            --bg-primary: #000000;
            --bg-secondary: #0a0a0a;
            --bg-tertiary: #111111;
            --bg-card: #0d1117;
            --bg-elevated: #161b22;
            
            /* Dark Blue Accents */
            --accent: #1e3a5f;
            --accent-light: #2d5a87;
            --accent-bright: #3b82f6;
            --accent-glow: rgba(59, 130, 246, 0.15);
            
            /* Status Colors */
            --success: #22c55e;
            --error: #ef4444;
            --warning: #f59e0b;
            
            /* Text Colors */
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #52525b;
            
            /* Borders */
            --border: #27272a;
            --border-light: #3f3f46;
            
            /* Spacing */
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }
        
        ::-webkit-scrollbar-thumb {
            background: var(--border-light);
            border-radius: 3px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
        
        /* Header */
        .header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 16px 32px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(10px);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 14px;
        }
        
        .logo-icon {
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            border: 1px solid var(--accent-light);
        }
        
        .logo-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .logo h1 {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
            letter-spacing: -0.5px;
        }
        
        .connection-status {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 18px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: 100px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-secondary);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: all 0.3s ease;
        }
        
        .status-dot.connected {
            background: var(--success);
            box-shadow: 0 0 12px var(--success);
        }
        
        /* Main Layout */
        .app-layout {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* Sidebar */
        .sidebar {
            width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }
        
        .sidebar-section {
            padding: 20px;
            border-bottom: 1px solid var(--border);
        }
        
        .sidebar-section h3 {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            margin-bottom: 16px;
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: 16px;
        }
        
        .form-group label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s ease;
        }
        
        .form-group input:hover {
            border-color: var(--border-light);
        }
        
        .form-group input:focus {
            outline: none;
            border-color: var(--accent-bright);
            background: var(--bg-elevated);
        }
        
        .form-group input::placeholder {
            color: var(--text-muted);
        }
        
        .btn {
            width: 100%;
            padding: 12px 20px;
            border: none;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            font-family: inherit;
        }
        
        .btn-primary {
            background: var(--accent-bright);
            color: var(--text-primary);
        }
        
        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }
        
        .btn-secondary:hover {
            background: var(--bg-elevated);
            border-color: var(--border-light);
        }
        
        .btn-danger {
            background: var(--error);
            color: white;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 16px;
        }
        
        .btn-group .btn {
            flex: 1;
        }
        
        /* Profile Card Styles */
        .profile-card {
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .profile-card:hover {
            border-color: var(--accent-bright);
            background: var(--bg-elevated);
        }
        
        .profile-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .profile-card-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
        }
        
        .profile-card-info {
            font-size: 12px;
            color: var(--text-muted);
            margin-bottom: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
        }
        
        .profile-card-actions {
            display: flex;
            gap: 8px;
        }
        
        .profile-btn {
            flex: 1;
            padding: 8px 12px;
            font-size: 12px;
            border: 1px solid var(--border);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 500;
        }
        
        .profile-btn:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
            border-color: var(--border-light);
        }
        
        .profile-btn.delete:hover {
            background: rgba(239, 68, 68, 0.15);
            color: var(--error);
            border-color: var(--error);
        }
        
        /* Nav Menu */
        .nav-menu {
            padding: 12px;
            flex: 1;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            font-size: 14px;
            margin-bottom: 4px;
            font-weight: 500;
        }
        
        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .nav-item.active {
            background: var(--accent);
            color: var(--text-primary);
        }
        
        .nav-item .icon {
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: var(--bg-primary);
        }
        
        .content-area {
            flex: 1;
            padding: 24px 32px;
            overflow-y: auto;
        }
        
        .panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            overflow: hidden;
        }
        
        .panel-header {
            padding: 18px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-secondary);
        }
        
        .panel-header h2 {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .panel-body {
            padding: 24px;
        }
        
        .panel-actions {
            display: flex;
            gap: 10px;
        }
        
        .panel-actions .btn {
            width: auto;
            padding: 8px 16px;
            font-size: 13px;
        }
        
        /* Cards Grid */
        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
            margin-bottom: 24px;
        }
        
        .card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
            transition: border-color 0.2s ease;
        }
        
        .card:hover {
            border-color: var(--border-light);
        }
        
        .card h4 {
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 16px;
            font-weight: 600;
        }
        
        .card .form-group {
            margin-bottom: 14px;
        }
        
        .card .btn {
            margin-top: 12px;
        }
        
        /* Output Box */
        .output-box {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 18px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.7;
            color: var(--text-secondary);
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        /* Terminal Panel */
        .terminal-panel {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            position: sticky;
            bottom: 0;
            z-index: 10;
        }
        
        .terminal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: var(--bg-tertiary);
            cursor: pointer;
            user-select: none;
            border-bottom: 1px solid var(--border);
        }
        
        .terminal-header h3 {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .terminal-header .terminal-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-muted);
            transition: all 0.3s ease;
        }
        
        .terminal-header .terminal-status.active {
            background: var(--success);
            box-shadow: 0 0 12px var(--success);
        }
        
        .terminal-tabs {
            display: flex;
            gap: 6px;
        }
        
        .terminal-tab {
            padding: 6px 14px;
            font-size: 12px;
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.15s ease;
            font-weight: 500;
        }
        
        .terminal-tab:hover {
            color: var(--text-primary);
            border-color: var(--border-light);
        }
        
        .terminal-tab.active {
            background: var(--accent-bright);
            color: var(--text-primary);
            border-color: var(--accent-bright);
        }
        
        .terminal-body {
            height: 320px;
            transition: height 0.2s ease;
            overflow: hidden;
            background: var(--bg-primary);
        }
        
        .terminal-body.collapsed {
            height: 0;
        }
        
        #terminal {
            height: 100%;
        }
        
        .terminal-log {
            height: 100%;
            overflow-y: auto;
            padding: 16px 20px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 13px;
            line-height: 1.7;
        }
        
        .log-entry {
            margin-bottom: 6px;
        }
        
        .log-entry .time {
            color: var(--text-muted);
            margin-right: 12px;
        }
        
        .log-entry .cmd {
            color: var(--accent-bright);
        }
        
        .log-entry .out {
            color: var(--text-secondary);
        }
        
        .log-entry .err {
            color: var(--error);
        }
        
        .log-entry .ok {
            color: var(--success);
        }
        
        .log-entry .warn {
            color: var(--warning);
        }
        
        /* Dashboard Styles */
        .dashboard-subtab {
            padding: 14px 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.15s ease;
            border-bottom: 2px solid transparent;
            margin-bottom: -1px;
        }
        
        .dashboard-subtab:hover {
            color: var(--text-primary);
        }
        
        .dashboard-subtab.active {
            color: var(--accent-bright);
            border-bottom-color: var(--accent-bright);
        }
        
        .dashboard-view {
            display: none;
        }
        
        .dashboard-view.active {
            display: block;
        }
        
        .job-card {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 20px;
            display: grid;
            grid-template-columns: auto 1fr auto auto;
            gap: 20px;
            align-items: center;
            transition: border-color 0.2s ease;
        }
        
        .job-card:hover {
            border-color: var(--border-light);
        }
        
        .job-status-badge {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 52px;
            height: 52px;
            border-radius: var(--radius-md);
            font-weight: 700;
            font-size: 11px;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .job-status-badge.success {
            background: var(--success);
        }
        
        .job-status-badge.warning {
            background: var(--warning);
        }
        
        .job-status-badge.error {
            background: var(--error);
        }
        
        .job-status-badge.info {
            background: var(--accent-bright);
        }
        
        .job-status-badge.muted {
            background: var(--text-muted);
        }
        
        .job-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 16px;
        }
        
        .job-info-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .job-info-item label {
            font-size: 11px;
            color: var(--text-muted);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .job-info-item value {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .job-actions {
            display: flex;
            gap: 10px;
            flex-direction: column;
        }
        
        .job-actions button {
            padding: 8px 14px;
            font-size: 12px;
            width: 90px;
        }
        
        /* Resize Handle */
        .resize-handle {
            height: 8px;
            background: var(--bg-tertiary);
            cursor: ns-resize;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.15s ease;
        }
        
        .resize-handle:hover {
            background: var(--bg-elevated);
        }
        
        .resize-handle::after {
            content: '';
            width: 40px;
            height: 3px;
            background: var(--border-light);
            border-radius: 2px;
            transition: background 0.15s ease;
        }
        
        .resize-handle:hover::after {
            background: var(--accent-bright);
        }
        
        /* Notification */
        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 14px 24px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 1000;
            animation: slideIn 0.3s ease;
            font-weight: 500;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        }
        
        .toast.success {
            border-color: var(--success);
            background: rgba(34, 197, 94, 0.1);
        }
        
        .toast.error {
            border-color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        /* Tab Content */
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Info Box */
        .info-box {
            background: rgba(59, 130, 246, 0.08);
            border: 1px solid rgba(59, 130, 246, 0.25);
            border-radius: var(--radius-md);
            padding: 14px 18px;
            margin-bottom: 20px;
            font-size: 14px;
            color: var(--accent-bright);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .info-box .icon {
            font-size: 16px;
        }
        
        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .stat-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 20px;
            text-align: center;
            transition: border-color 0.2s ease;
        }
        
        .stat-card:hover {
            border-color: var(--border-light);
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: -300px;
                top: 0;
                bottom: 0;
                z-index: 100;
                transition: left 0.3s ease;
            }
            
            .sidebar.open {
                left: 0;
            }
            
            .header {
                padding: 12px 16px;
            }
            
            .content-area {
                padding: 16px;
            }
            
            .cards-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Mobile Menu Toggle */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
        }
        
        @media (max-width: 768px) {
            .mobile-menu-btn {
                display: block;
            }
        }
        
        /* Overlay for mobile sidebar */
        .sidebar-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 99;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Mobile Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>
    
    <!-- Header -->
    <header class="header">
        <div class="logo">
            <button class="mobile-menu-btn" onclick="toggleSidebar()">‚ò∞</button>
            <div class="logo-icon"><img src="/static/nsm.png" alt="PARAM"></div>
            <h1>PARAM Console</h1>
        </div>
        <div class="connection-status">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusText">Disconnected</span>
        </div>
    </header>
    
    <!-- Main Layout -->
    <div class="app-layout">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-section">
                <h3>SSH Connection</h3>
                <div class="form-group">
                    <label>Host</label>
                    <input type="text" id="host" value="paramutkarsh.cdac.in" placeholder="Enter hostname">
                </div>
                <div class="form-group">
                    <label>Username</label>
                    <input type="text" id="user" placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label>Port</label>
                    <input type="text" id="port" value="4422" placeholder="22">
                </div>
                <button class="btn btn-primary" onclick="openTerminalAndConnect()">
                    Connect
                </button>
                <p style="font-size: 12px; color: var(--text-muted); margin-top: 12px; text-align: center; line-height: 1.5;">
                    Interactive terminal with password/OTP support
                </p>
            </div>
            
            <!-- Saved Profiles Section -->
            <div class="sidebar-section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h3 style="margin: 0;">Saved Profiles</h3>
                    <button class="btn btn-secondary" onclick="toggleSaveProfileModal()" style="width: auto; padding: 6px 12px; font-size: 12px;">
                        + Add
                    </button>
                </div>
                
                <!-- Save Profile Modal -->
                <div id="saveProfileModal" style="display: none; padding: 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); margin-bottom: 16px; border: 1px solid var(--border);">
                    <h4 style="margin: 0 0 16px 0; font-size: 14px; font-weight: 600;">Save Current Connection</h4>
                    <div class="form-group">
                        <label>Profile Name</label>
                        <input type="text" id="profileName" placeholder="e.g., Production Server">
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="saveCurrentProfile()" style="font-size: 13px; flex: 1;">Save</button>
                        <button class="btn btn-secondary" onclick="toggleSaveProfileModal()" style="font-size: 13px; flex: 1;">Cancel</button>
                    </div>
                </div>
                
                <!-- Profiles List -->
                <div id="profilesList" style="max-height: 300px; overflow-y: auto;">
                    <div style="text-align: center; padding: 24px; color: var(--text-muted); font-size: 13px;">
                        No saved profiles yet
                    </div>
                </div>
            </div>
            
            <nav class="nav-menu">
                <div class="nav-item active" onclick="switchTab('files')">
                    <span class="icon">üìÅ</span>
                    <span>File Manager</span>
                </div>
                <div class="nav-item" onclick="switchTab('slurm')">
                    <span class="icon">üìä</span>
                    <span>SLURM Jobs</span>
                </div>
                <div class="nav-item" onclick="switchTab('conda')">
                    <span class="icon">üêç</span>
                    <span>Conda Environments</span>
                </div>
                <div class="nav-item" onclick="switchTab('system')">
                    <span class="icon">üíª</span>
                    <span>System Info</span>
                </div>
            </nav>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <div class="content-area">
                <!-- SLURM Tab -->
                <div id="slurm" class="tab-content">
                    <!-- Dashboard Header -->
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px;">
                        <h2 style="margin: 0; font-size: 24px; font-weight: 600;">SLURM Dashboard</h2>
                        <div style="display: flex; gap: 12px; align-items: center;">
                            <button class="btn btn-secondary" onclick="loadDashboard()" style="width: auto; padding: 10px 20px;">
                                Refresh
                            </button>
                            <label style="display: flex; align-items: center; gap: 10px; padding: 10px 16px; background: var(--bg-tertiary); border-radius: var(--radius-md); cursor: pointer; border: 1px solid var(--border); font-size: 13px; font-weight: 500;">
                                <input type="checkbox" id="autoRefresh" onchange="toggleAutoRefresh()" style="accent-color: var(--accent-bright);">
                                Auto Refresh
                            </label>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalJobsCount" style="color: var(--accent-bright);">0</div>
                            <div class="stat-label">Total Jobs</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="runningJobsCount" style="color: var(--success);">0</div>
                            <div class="stat-label">Running</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="pendingJobsCount" style="color: var(--warning);">0</div>
                            <div class="stat-label">Pending</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalNodesCount" style="color: var(--text-primary);">0</div>
                            <div class="stat-label">Nodes</div>
                        </div>
                    </div>
                    
                    <!-- Tabs for different views -->
                    <div style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border); flex-wrap: wrap;">
                        <button class="dashboard-subtab active" onclick="switchDashboardView('jobs')">Jobs</button>
                        <button class="dashboard-subtab" onclick="switchDashboardView('nodes')">Nodes</button>
                        <button class="dashboard-subtab" onclick="switchDashboardView('gpu')">GPU Info</button>
                        <button class="dashboard-subtab" onclick="switchDashboardView('submit')">Submit Job</button>
                    </div>
                    
                    <!-- Jobs View -->
                    <div id="jobs-view" class="dashboard-view active">
                        <div style="display: grid; gap: 16px;" id="jobsContainer">
                            <div style="text-align: center; padding: 60px; color: var(--text-muted); font-size: 14px;">
                                Connect to load job data
                            </div>
                        </div>
                    </div>
                    
                    <!-- Nodes View -->
                    <div id="nodes-view" class="dashboard-view" style="display: none;">
                        <div class="panel">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="border-bottom: 1px solid var(--border);">
                                        <th style="text-align: left; padding: 14px 16px; color: var(--text-secondary); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Node Name</th>
                                        <th style="text-align: left; padding: 14px 16px; color: var(--text-secondary); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">State</th>
                                        <th style="text-align: left; padding: 14px 16px; color: var(--text-secondary); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">CPUs</th>
                                        <th style="text-align: left; padding: 14px 16px; color: var(--text-secondary); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Memory</th>
                                        <th style="text-align: left; padding: 14px 16px; color: var(--text-secondary); font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">GPUs</th>
                                    </tr>
                                </thead>
                                <tbody id="nodesTableBody">
                                    <tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">Connect to load node data</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- GPU Info View -->
                    <div id="gpu-view" class="dashboard-view" style="display: none;">
                        <div id="gpuContainer" style="display: grid; gap: 16px;">
                            <div style="text-align: center; padding: 60px; color: var(--text-muted); font-size: 14px;">
                                Connect to load GPU information
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Job View -->
                    <div id="submit-view" class="dashboard-view" style="display: none;">
                        <div class="card" style="max-width: 480px;">
                            <h4>Submit SLURM Job</h4>
                            <div class="form-group">
                                <label>Script Path</label>
                                <input type="text" id="scriptPath" placeholder="/path/to/your/script.sh">
                            </div>
                            <button class="btn btn-primary" onclick="submitJob()">
                                Submit Job
                            </button>
                        </div>
                    </div>
                    
                    <!-- Quick Commands -->
                    <div style="margin-top: 32px; padding-top: 24px; border-top: 1px solid var(--border);">
                        <h4 style="margin-bottom: 16px; font-size: 16px; font-weight: 600;">Quick Commands</h4>
                        <div class="cards-grid" style="grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));">
                            <div class="card">
                                <h4>Job Details</h4>
                                <div class="form-group">
                                    <input type="text" id="jobIdInfo" placeholder="Enter Job ID">
                                </div>
                                <button class="btn btn-secondary" onclick="jobInfo()">Get Info</button>
                            </div>
                            <div class="card">
                                <h4>Cancel Job</h4>
                                <div class="form-group">
                                    <input type="text" id="jobIdCancel" placeholder="Enter Job ID">
                                </div>
                                <button class="btn btn-danger" onclick="cancelJob()">Cancel Job</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Conda Tab -->
                <div id="conda" class="tab-content">
                    <h2 style="margin: 0 0 24px 0; font-size: 24px; font-weight: 600;">Conda Environments</h2>
                    <div class="cards-grid">
                        <div class="card">
                            <h4>View Environments</h4>
                            <p style="font-size: 13px; color: var(--text-muted); margin-bottom: 16px;">List all available conda environments</p>
                            <button class="btn btn-secondary" onclick="runCommand('conda env list')">
                                List Environments
                            </button>
                        </div>
                        
                        <div class="card">
                            <h4>Create Environment</h4>
                            <div class="form-group">
                                <label>Environment Name</label>
                                <input type="text" id="envName" placeholder="my-project-env">
                            </div>
                            <div class="form-group">
                                <label>Python Version (optional)</label>
                                <input type="text" id="pythonVer" placeholder="3.10">
                            </div>
                            <button class="btn btn-primary" onclick="createEnv()">
                                Create Environment
                            </button>
                        </div>
                        
                        <div class="card">
                            <h4>Install Package</h4>
                            <div class="form-group">
                                <label>Environment Name</label>
                                <input type="text" id="envNamePkg" placeholder="my-project-env">
                            </div>
                            <div class="form-group">
                                <label>Package Name</label>
                                <input type="text" id="pkgName" placeholder="numpy pandas scikit-learn">
                            </div>
                            <button class="btn btn-secondary" onclick="installPkg()">
                                Install Package
                            </button>
                        </div>
                        
                        <div class="card">
                            <h4>Remove Environment</h4>
                            <div class="form-group">
                                <label>Environment Name</label>
                                <input type="text" id="envNameDel" placeholder="old-env">
                            </div>
                            <button class="btn btn-danger" onclick="removeEnv()">
                                Remove Environment
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- System Tab -->
                <div id="system" class="tab-content">
                    <h2 style="margin: 0 0 24px 0; font-size: 24px; font-weight: 600;">System Information</h2>
                    
                    <!-- System Stats Cards -->
                    <div class="stats-grid" style="margin-bottom: 24px;">
                        <div class="stat-card" id="sysOsCard">
                            <div class="stat-value" style="font-size: 18px; color: var(--text-primary);">-</div>
                            <div class="stat-label">Operating System</div>
                        </div>
                        <div class="stat-card" id="sysHostCard">
                            <div class="stat-value" style="font-size: 18px; color: var(--accent-bright);">-</div>
                            <div class="stat-label">Hostname</div>
                        </div>
                        <div class="stat-card" id="sysCpuCard">
                            <div class="stat-value" style="font-size: 18px; color: var(--success);">-</div>
                            <div class="stat-label">CPU Cores</div>
                        </div>
                        <div class="stat-card" id="sysMemCard">
                            <div class="stat-value" style="font-size: 18px; color: var(--warning);">-</div>
                            <div class="stat-label">Memory</div>
                        </div>
                    </div>
                    
                    <div class="panel">
                        <div class="panel-header">
                            <h2>Quick Actions</h2>
                            <div class="panel-actions">
                                <button class="btn btn-secondary" onclick="getSystemInfo()">Refresh Info</button>
                                <button class="btn btn-secondary" onclick="runCommand('uname -a')">OS Info</button>
                                <button class="btn btn-secondary" onclick="runCommand('df -h')">Disk Usage</button>
                                <button class="btn btn-secondary" onclick="runCommand('free -h')">Memory</button>
                                <button class="btn btn-secondary" onclick="runCommand('nvidia-smi')">GPU Status</button>
                            </div>
                        </div>
                        <div class="panel-body">
                            <div class="cards-grid">
                                <div class="card">
                                    <h4>System Load</h4>
                                    <button class="btn btn-secondary" onclick="runCommand('uptime')">Check Uptime</button>
                                    <button class="btn btn-secondary" onclick="runCommand('top -bn1 | head -20')" style="margin-top: 8px;">Top Processes</button>
                                </div>
                                <div class="card">
                                    <h4>Network</h4>
                                    <button class="btn btn-secondary" onclick="runCommand('hostname -I')">IP Address</button>
                                    <button class="btn btn-secondary" onclick="runCommand('netstat -tuln | head -20')" style="margin-top: 8px;">Open Ports</button>
                                </div>
                                <div class="card">
                                    <h4>Environment</h4>
                                    <button class="btn btn-secondary" onclick="runCommand('echo $PATH | tr \":\" \"\\n\"')">View PATH</button>
                                    <button class="btn btn-secondary" onclick="runCommand('module list')" style="margin-top: 8px;">Loaded Modules</button>
                                </div>
                                <div class="card">
                                    <h4>Storage</h4>
                                    <button class="btn btn-secondary" onclick="runCommand('lfs quota -h ~/')">Quota</button>
                                    <button class="btn btn-secondary" onclick="runCommand('du -sh ~/* 2>/dev/null | sort -hr | head -10')" style="margin-top: 8px;">Largest Dirs</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Files Tab -->
                <div id="files" class="tab-content active">
                    <!-- File Browser Section -->
                    <h2 style="margin: 0 0 24px 0; font-size: 24px; font-weight: 600;">File Manager</h2>
                    <div class="panel" style="margin-bottom: 24px;" id="browseFilesPanel">
                        <div class="panel-header" style="cursor: pointer;" onclick="toggleBrowseFilesPanel()">
                            <h2 style="display: flex; align-items: center; gap: 8px;">
                                <span id="browseFilesPanelIcon" style="transition: transform 0.2s;">‚ñº</span>
                                Browse Files
                            </h2>
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;" onclick="event.stopPropagation();">
                                <input type="text" id="browsePath" placeholder="Enter path (e.g., ~, ~/home)" 
                                    style="padding: 10px 14px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-md); color: var(--text-primary); font-size: 14px; width: 280px;">
                                <button class="btn btn-primary" onclick="browseDirectory()" style="width: auto; padding: 10px 20px;">Browse</button>
                                <button class="btn btn-secondary" onclick="browseHome()" style="width: auto; padding: 10px 16px;">Home</button>
                            </div>
                        </div>
                        <div class="panel-body" id="browseFilesPanelBody">
                            <div id="filesBrowser" style="overflow-x: auto;">
                                <div style="text-align: center; padding: 48px; color: var(--text-muted);">
                                    Enter a path and click Browse to view files
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="cards-grid">
                        <!-- File Upload Card -->
                        <div class="card">
                            <h4>Upload File</h4>
                            <div class="form-group">
                                <label>Local File</label>
                                <input type="file" id="fileInput" style="padding: 8px; font-size: 13px; width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-md); color: var(--text-primary);">
                            </div>
                            <div class="form-group">
                                <label>Remote Path</label>
                                <input type="text" id="uploadRemotePath" placeholder="~/myfile.txt" value="~/uploads/">
                            </div>
                            <button class="btn btn-primary" onclick="uploadFileToRemote()">Upload</button>
                            <div id="uploadStatus" style="margin-top: 10px; font-size: 13px;"></div>
                        </div>
                        
                        <!-- File Download Card -->
                        <div class="card">
                            <h4>Download File</h4>
                            <div class="form-group">
                                <label>Remote File Path</label>
                                <input type="text" id="downloadRemotePath" placeholder="~/myfile.txt">
                            </div>
                            <button class="btn btn-primary" onclick="downloadFile()">Download</button>
                            <div id="downloadStatus" style="margin-top: 10px; font-size: 13px;"></div>
                        </div>
                        
                        <!-- File Search Card -->
                        <div class="card">
                            <h4>Search Files</h4>
                            <div class="form-group">
                                <label>Search Path</label>
                                <input type="text" id="searchPath" placeholder="~" value="~">
                            </div>
                            <div class="form-group">
                                <label>File Pattern</label>
                                <input type="text" id="searchPattern" placeholder="*.py">
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="searchDepth" style="accent-color: var(--accent-bright);">
                                    <span>Current directory only</span>
                                </label>
                            </div>
                            <button class="btn btn-primary" onclick="searchFiles()">Search</button>
                        </div>
                        
                        <!-- View File Content Card -->
                        <div class="card">
                            <h4>View File Content</h4>
                            <div class="form-group">
                                <label>File Path</label>
                                <input type="text" id="viewFilePath" placeholder="~/script.py">
                            </div>
                            <div class="form-group">
                                <label>Lines to show</label>
                                <input type="number" id="viewLines" value="50" min="10" max="1000">
                            </div>
                            <button class="btn btn-primary" onclick="viewFileContent()">View</button>
                        </div>
                        
                        <!-- Create Directory Card -->
                        <div class="card">
                            <h4>Create Directory</h4>
                            <div class="form-group">
                                <label>Directory Path</label>
                                <input type="text" id="createDirPath" placeholder="~/new_folder">
                            </div>
                            <button class="btn btn-primary" onclick="createDirectory()">Create</button>
                        </div>
                        
                        <!-- Delete File/Directory Card -->
                        <div class="card">
                            <h4>Delete File/Directory</h4>
                            <div class="form-group">
                                <label>Path</label>
                                <input type="text" id="deletePath" placeholder="~/file_or_folder">
                            </div>
                            <div class="form-group">
                                <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                                    <input type="checkbox" id="deleteIsDir" style="accent-color: var(--accent-bright);">
                                    <span>Is Directory</span>
                                </label>
                            </div>
                            <button class="btn btn-danger" onclick="deleteFileOrDir()">Delete</button>
                        </div>
                        
                        <!-- Rename/Move Card -->
                        <div class="card">
                            <h4>Rename / Move</h4>
                            <div class="form-group">
                                <label>Old Path</label>
                                <input type="text" id="renameOldPath" placeholder="~/oldname.txt">
                            </div>
                            <div class="form-group">
                                <label>New Path</label>
                                <input type="text" id="renameNewPath" placeholder="~/newname.txt">
                            </div>
                            <button class="btn btn-primary" onclick="renameFile()">Rename/Move</button>
                        </div>
                        
                        <!-- Edit File Card -->
                        <div class="card">
                            <h4>Edit File (nano)</h4>
                            <div class="form-group">
                                <label>Directory Path</label>
                                <input type="text" id="editFilePath" placeholder="~/">
                            </div>
                            <div class="form-group">
                                <label>File Name</label>
                                <input type="text" id="editFileName" placeholder="script.py">
                            </div>
                            <button class="btn btn-primary" onclick="editFile()">Edit in Terminal</button>
                            <p style="font-size: 12px; color: var(--text-muted); margin-top: 10px;">Opens nano editor in terminal</p>
                        </div>
                        
                        <!-- Disk Usage Card -->
                        <div class="card" style="grid-column: 1 / -1;">
                            <h4>Disk Usage & Quota</h4>
                            <div style="display: flex; gap: 16px; align-items: flex-end; flex-wrap: wrap;">
                                <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;">
                                    <label>Path</label>
                                    <input type="text" id="diskQuotaPath" placeholder="~" value="~">
                                </div>
                                <button class="btn btn-primary" onclick="checkDiskQuota()" style="width: auto; padding: 12px 24px;">Check Usage</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- File Content Viewer -->
                    <div id="fileContentViewer" style="display: none; margin-top: 24px;">
                        <div class="panel">
                            <div class="panel-header">
                                <h2 id="fileContentTitle">File Content</h2>
                                <button class="btn btn-secondary" onclick="closeFileViewer()" style="width: auto; padding: 8px 16px;">Close</button>
                            </div>
                            <div class="panel-body">
                                <div class="output-box" id="fileContentDisplay" style="max-height: 500px; font-family: 'Monaco', 'Menlo', 'Consolas', monospace; white-space: pre; overflow-x: auto;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Terminal Panel -->
            <div class="terminal-panel">
                <div class="resize-handle" id="resizeHandle"></div>
                <div class="terminal-header" onclick="toggleTerminal()">
                    <h3>
                        Terminal
                        <span class="terminal-status" id="terminalStatus"></span>
                    </h3>
                    <div class="terminal-tabs" onclick="event.stopPropagation()">
                        <button class="terminal-tab active" id="shellTabBtn" onclick="switchTerminalMode('shell')">Shell</button>
                        <button class="terminal-tab" id="logTabBtn" onclick="switchTerminalMode('log')">Log</button>
                        <button class="terminal-tab" onclick="clearTerminal()">Clear</button>
                    </div>
                </div>
                <div class="terminal-body" id="terminalBody">
                    <div id="terminal"></div>
                    <div class="terminal-log" id="terminalLog" style="display: none;">
                        <div class="log-entry">
                            <span class="warn">Connect to start using PARAM SSH Manager</span>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <div id="toastContainer"></div>
    
    <script>
        let term = null;
        let fitAddon = null;
        let ws = null;
        let terminalMode = 'shell';
        let isConnected = false;
        let terminalCollapsed = false;
        
        // Mobile sidebar functions
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }
        
        function closeSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }
        
        // Initialize xterm.js with new theme
        function initTerminal() {
            term = new Terminal({
                cursorBlink: true,
                fontSize: 14,
                fontFamily: "'Monaco', 'Menlo', 'Consolas', monospace",
                lineHeight: 1.2,
                letterSpacing: 0,
                theme: {
                    background: '#000000',
                    foreground: '#e4e4e7',
                    cursor: '#3b82f6',
                    cursorAccent: '#000000',
                    selectionBackground: 'rgba(59, 130, 246, 0.3)',
                    selectionForeground: '#ffffff',
                    black: '#000000',
                    red: '#ef4444',
                    green: '#22c55e',
                    yellow: '#f59e0b',
                    blue: '#3b82f6',
                    magenta: '#a855f7',
                    cyan: '#06b6d4',
                    white: '#e4e4e7',
                    brightBlack: '#52525b',
                    brightRed: '#f87171',
                    brightGreen: '#4ade80',
                    brightYellow: '#fbbf24',
                    brightBlue: '#60a5fa',
                    brightMagenta: '#c084fc',
                    brightCyan: '#22d3ee',
                    brightWhite: '#ffffff'
                }
            });
            
            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            term.loadAddon(new WebLinksAddon.WebLinksAddon());
            
            term.open(document.getElementById('terminal'));
            fitAddon.fit();
            
            term.onData(data => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(JSON.stringify({ type: 'input', data: data }));
                }
            });
            
            window.addEventListener('resize', () => {
                if (fitAddon) {
                    fitAddon.fit();
                    if (ws && ws.readyState === WebSocket.OPEN) {
                        ws.send(JSON.stringify({ type: 'resize', cols: term.cols, rows: term.rows }));
                    }
                }
            });
            
            term.writeln('\x1b[34m‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê\x1b[0m');
            term.writeln('\x1b[34m‚îÇ\x1b[0m  \x1b[1;37mPARAM SSH Manager\x1b[0m                                          \x1b[34m‚îÇ\x1b[0m');
            term.writeln('\x1b[34m‚îÇ\x1b[0m  Click "Connect" to start your SSH session                  \x1b[34m‚îÇ\x1b[0m');
            term.writeln('\x1b[34m‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò\x1b[0m');
            term.writeln('');
        }
        
        function openTerminalAndConnect() {
            const host = document.getElementById('host').value;
            const user = document.getElementById('user').value;
            const port = document.getElementById('port').value;
            
            if (!host || !user) {
                showToast('Please enter host and username', 'error');
                return;
            }
            
            // Close mobile sidebar if open
            closeSidebar();
            
            // Make sure terminal is visible and in shell mode
            if (terminalCollapsed) {
                toggleTerminal();
            }
            switchTerminalMode('shell');
            
            // Close existing connection
            if (ws) {
                ws.close();
            }
            
            term.clear();
            term.writeln(`\x1b[34mConnecting to ${user}@${host}:${port}...\x1b[0m`);
            term.writeln('\x1b[90mYou will be prompted for password/OTP authentication.\x1b[0m');
            term.writeln('');
            
            const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${wsProtocol}//${window.location.host}/ws/terminal`);
            
            ws.onopen = () => {
                ws.send(JSON.stringify({
                    type: 'connect',
                    host: host,
                    user: user,
                    port: port
                }));
                document.getElementById('terminalStatus').classList.add('active');
            };
            
            ws.onmessage = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'output') {
                    term.write(msg.data);
                    
                    // Auto-scroll to bottom
                    setTimeout(() => {
                        term.scrollToBottom();
                    }, 10);
                    
                    // Detect successful login
                    if (msg.data.includes('Last login') || msg.data.includes('$') || msg.data.includes('#')) {
                        if (!isConnected) {
                            isConnected = true;
                            updateConnectionStatus(true);
                            logToTerminal(`Connected to ${user}@${host}`, 'ok');
                        }
                    }
                } else if (msg.type === 'connected') {
                    logToTerminal(`SSH session started to ${user}@${host}`, 'warn');
                } else if (msg.type === 'error') {
                    term.writeln(`\x1b[31mError: ${msg.data}\x1b[0m`);
                    logToTerminal(msg.data, 'err');
                    setTimeout(() => {
                        term.scrollToBottom();
                    }, 10);
                }
            };
            
            ws.onclose = () => {
                document.getElementById('terminalStatus').classList.remove('active');
                term.writeln('\r\n\x1b[33mConnection closed.\x1b[0m');
                isConnected = false;
                updateConnectionStatus(false);
                logToTerminal('Connection closed', 'warn');
            };
            
            ws.onerror = () => {
                term.writeln('\r\n\x1b[31mWebSocket error occurred.\x1b[0m');
                logToTerminal('WebSocket error', 'err');
            };
            
            setTimeout(() => fitAddon.fit(), 100);
            term.focus();
        }
        
        function runCommand(cmd) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showToast('Not connected. Use "Connect via Terminal" first.', 'error');
                return;
            }
            
            logToTerminal(cmd, 'cmd');
            ws.send(JSON.stringify({ type: 'input', data: cmd + '\n' }));
            
            // Switch to terminal to see output
            if (terminalMode !== 'shell') {
                switchTerminalMode('shell');
            }
            
            // Ensure terminal is visible
            if (terminalCollapsed) {
                toggleTerminal();
            }
            
            // Scroll to bottom and focus
            setTimeout(() => {
                term.scrollToBottom();
                term.focus();
            }, 50);
        }
        
        function submitJob() {
            const path = document.getElementById('scriptPath').value;
            if (!path) {
                showToast('Enter script path', 'error');
                return;
            }
            runCommand(`sbatch ${path}`);
        }
        
        function jobInfo() {
            const id = document.getElementById('jobIdInfo').value;
            if (!id) {
                showToast('Enter job ID', 'error');
                return;
            }
            runCommand(`scontrol show job ${id}`);
        }
        
        function cancelJob() {
            const id = document.getElementById('jobIdCancel').value;
            if (!id) {
                showToast('Enter job ID', 'error');
                return;
            }
            if (confirm(`Cancel job ${id}?`)) {
                runCommand(`scancel ${id}`);
            }
        }
        
        function createEnv() {
            const name = document.getElementById('envName').value;
            const pyVer = document.getElementById('pythonVer').value;
            if (!name) {
                showToast('Enter environment name', 'error');
                return;
            }
            const cmd = pyVer 
                ? `conda create -n ${name} python=${pyVer} -y`
                : `conda create -n ${name} -y`;
            runCommand(cmd);
        }
        
        function installPkg() {
            const env = document.getElementById('envNamePkg').value;
            const pkg = document.getElementById('pkgName').value;
            if (!env || !pkg) {
                showToast('Fill in all fields', 'error');
                return;
            }
            runCommand(`conda install -n ${env} ${pkg} -y`);
        }
        
        function removeEnv() {
            const name = document.getElementById('envNameDel').value;
            if (!name) {
                showToast('Enter environment name', 'error');
                return;
            }
            if (confirm(`Remove environment "${name}"?`)) {
                runCommand(`conda env remove -n ${name} -y`);
            }
        }
        
        // System Information Functions
        async function getSystemInfo() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showToast('Not connected to SSH', 'error');
                return;
            }
            
            showToast('Fetching system info...', 'info');
            
            // Get OS info
            runCommandSilent('uname -s', (output) => {
                const osCard = document.getElementById('sysOsCard');
                const lines = output.split('\n').filter(l => 
                    l.trim() !== '' && 
                    !l.includes('$') && 
                    !l.includes('#') && 
                    !l.includes('uname')
                );
                if (lines.length > 0) {
                    osCard.querySelector('.stat-value').textContent = lines[0].trim();
                }
            });
            
            // Get hostname
            runCommandSilent('hostname', (output) => {
                const hostCard = document.getElementById('sysHostCard');
                const lines = output.split('\n').filter(l => 
                    l.trim() !== '' && 
                    !l.includes('$') && 
                    !l.includes('#') && 
                    !l.includes('hostname')
                );
                if (lines.length > 0) {
                    hostCard.querySelector('.stat-value').textContent = lines[0].trim();
                }
            });
            
            // Get CPU cores
            runCommandSilent('nproc', (output) => {
                const cpuCard = document.getElementById('sysCpuCard');
                const lines = output.split('\n').filter(l => 
                    l.trim() !== '' && 
                    !l.includes('$') && 
                    !l.includes('#') && 
                    !l.includes('nproc') &&
                    /^\d+$/.test(l.trim())
                );
                if (lines.length > 0) {
                    cpuCard.querySelector('.stat-value').textContent = lines[0].trim() + ' cores';
                }
            });
            
            // Get memory info
            runCommandSilent('free -h | grep Mem', (output) => {
                const memCard = document.getElementById('sysMemCard');
                const lines = output.split('\n').filter(l => 
                    l.trim() !== '' && 
                    !l.includes('$') && 
                    !l.includes('#') && 
                    l.includes('Mem')
                );
                if (lines.length > 0) {
                    const parts = lines[0].trim().split(/\s+/);
                    if (parts.length >= 2) {
                        memCard.querySelector('.stat-value').textContent = parts[1]; // Total memory
                    }
                }
            });
        }
        
        function updateConnectionStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            if (connected) {
                dot.classList.add('connected');
                const user = document.getElementById('user').value;
                const host = document.getElementById('host').value;
                text.textContent = `${user}@${host}`;
            } else {
                dot.classList.remove('connected');
                text.textContent = 'Disconnected';
            }
        }
        
        function switchTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            
            // Load data when switching to specific tabs
            if (tabName === 'slurm') {
                loadDashboard();
            } else if (tabName === 'system') {
                getSystemInfo();
            }
        }
        
        // SSH Profiles Management
        async function loadProfiles() {
            try {
                const response = await fetch('/api/profiles');
                const data = await response.json();
                
                if (data.success && data.profiles.length > 0) {
                    const profilesList = document.getElementById('profilesList');
                    profilesList.innerHTML = data.profiles.map(profile => `
                        <div class="profile-card">
                            <div class="profile-card-header">
                                <span class="profile-card-name">${escapeHtml(profile.name)}</span>
                                <span style="font-size: 11px; color: var(--text-muted);">
                                    ${profile.last_used ? new Date(profile.last_used).toLocaleDateString() : ''}
                                </span>
                            </div>
                            <div class="profile-card-info">
                                ${escapeHtml(profile.user)}@${escapeHtml(profile.host)}:${profile.port}
                            </div>
                            <div class="profile-card-actions">
                                <button class="profile-btn" onclick="connectWithProfile(${profile.id}, '${escapeHtml(profile.host)}', '${escapeHtml(profile.user)}', ${profile.port})">
                                    Connect
                                </button>
                                <button class="profile-btn" onclick="editProfile(${profile.id})">
                                    Edit
                                </button>
                                <button class="profile-btn delete" onclick="deleteProfile(${profile.id})">
                                    Delete
                                </button>
                            </div>
                        </div>
                    `).join('');
                } else {
                    document.getElementById('profilesList').innerHTML = `
                        <div style="text-align: center; padding: 32px 16px; color: var(--text-muted); font-size: 13px;">
                            No saved profiles yet
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading profiles:', error);
                showToast('Failed to load profiles', 'error');
            }
        }
        
        function toggleSaveProfileModal() {
            const modal = document.getElementById('saveProfileModal');
            modal.style.display = modal.style.display === 'none' ? 'block' : 'none';
        }
        
        async function saveCurrentProfile() {
            const name = document.getElementById('profileName').value.trim();
            const host = document.getElementById('host').value.trim();
            const user = document.getElementById('user').value.trim();
            const port = parseInt(document.getElementById('port').value) || 22;
            
            if (!name) {
                showToast('Please enter a profile name', 'error');
                return;
            }
            
            if (!host || !user) {
                showToast('Please fill in host and username first', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/profiles/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, host, user, port })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast(`Profile "${name}" saved!`, 'success');
                    document.getElementById('profileName').value = '';
                    toggleSaveProfileModal();
                    loadProfiles();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Save profile error:', error);
                showToast('Failed to save profile', 'error');
            }
        }
        
        async function deleteProfile(profileId) {
            if (!confirm('Delete this profile?')) return;
            
            try {
                const response = await fetch(`/api/profiles/${profileId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Profile deleted', 'success');
                    loadProfiles();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                console.error('Delete profile error:', error);
                showToast('Failed to delete profile', 'error');
            }
        }
        
        function connectWithProfile(profileId, host, user, port) {
            // Populate the connection form
            document.getElementById('host').value = host;
            document.getElementById('user').value = user;
            document.getElementById('port').value = port;
            
            // Connect
            openTerminalAndConnect();
            
            showToast(`Connecting to ${user}@${host}...`, 'success');
        }
        
        function editProfile(profileId) {
            showToast('Edit feature coming soon', 'info');
        }
        
        function switchTerminalMode(mode) {
            terminalMode = mode;
            
            document.getElementById('shellTabBtn').classList.toggle('active', mode === 'shell');
            document.getElementById('logTabBtn').classList.toggle('active', mode === 'log');
            
            document.getElementById('terminal').style.display = mode === 'shell' ? 'block' : 'none';
            document.getElementById('terminalLog').style.display = mode === 'log' ? 'block' : 'none';
            
            if (mode === 'shell' && term) {
                setTimeout(() => {
                    fitAddon.fit();
                    term.focus();
                }, 50);
            }
        }
        
        function toggleTerminal() {
            terminalCollapsed = !terminalCollapsed;
            document.getElementById('terminalBody').classList.toggle('collapsed', terminalCollapsed);
            if (!terminalCollapsed && fitAddon) {
                setTimeout(() => {
                    fitAddon.fit();
                    term.scrollToBottom();
                }, 100);
            }
        }
        
        function clearTerminal() {
            if (terminalMode === 'shell' && term) {
                term.clear();
            } else {
                document.getElementById('terminalLog').innerHTML = '';
            }
        }
        
        function logToTerminal(message, type = 'out') {
            const log = document.getElementById('terminalLog');
            const time = new Date().toLocaleTimeString();
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerHTML = `<span class="time">[${time}]</span><span class="${type}">${escapeHtml(message)}</span>`;
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function showToast(message, type = 'success') {
            const container = document.getElementById('toastContainer');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            const icon = type === 'error' ? '‚úï' : type === 'info' ? '‚Ñπ' : '‚úì';
            toast.innerHTML = `<span style="font-size: 16px;">${icon}</span> ${message}`;
            container.appendChild(toast);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateX(20px)';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }
        
        // Resize handle
        let isResizing = false;
        let startY, startHeight;
        
        document.getElementById('resizeHandle').addEventListener('mousedown', (e) => {
            isResizing = true;
            startY = e.clientY;
            startHeight = document.getElementById('terminalBody').offsetHeight;
            document.body.style.cursor = 'ns-resize';
            e.preventDefault();
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isResizing) return;
            const diff = startY - e.clientY;
            const newHeight = Math.max(100, Math.min(800, startHeight + diff));
            document.getElementById('terminalBody').style.height = newHeight + 'px';
            if (fitAddon) {
                fitAddon.fit();
                term.scrollToBottom();
            }
        });
        
        document.addEventListener('mouseup', () => {
            if (isResizing) {
                isResizing = false;
                document.body.style.cursor = '';
            }
        });
        
        // Init
        document.addEventListener('DOMContentLoaded', initTerminal);
        
        // File Management Functions
        async function uploadFile() {
            const fileInput = document.getElementById('fileInput');
            const statusDiv = document.getElementById('uploadStatus');
            
            if (!fileInput.files.length) {
                statusDiv.textContent = '‚ùå Please select a file';
                statusDiv.style.color = 'var(--error)';
                return;
            }
            
            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append('file', file);
            
            statusDiv.textContent = '‚è≥ Uploading...';
            statusDiv.style.color = 'var(--warning)';
            
            try {
                const response = await fetch('/api/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    statusDiv.textContent = `‚úì File uploaded: ${data.filename}`;
                    statusDiv.style.color = 'var(--success)';
                    fileInput.value = '';
                    loadFiles();
                    showToast('File uploaded successfully', 'success');
                } else {
                    statusDiv.textContent = `‚ùå ${data.message}`;
                    statusDiv.style.color = 'var(--error)';
                    showToast(data.message, 'error');
                }
            } catch (error) {
                statusDiv.textContent = `‚ùå Upload failed: ${error.message}`;
                statusDiv.style.color = 'var(--error)';
                showToast('Upload failed', 'error');
            }
        }
        
        async function loadFiles() {
            const filesList = document.getElementById('filesList');
            filesList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">Loading...</div>';
            
            try {
                const response = await fetch('/api/files');
                const data = await response.json();
                
                if (data.success && data.files.length > 0) {
                    let html = '<div style="display: grid; gap: 8px;">';
                    
                    data.files.forEach(file => {
                        const fileSize = formatFileSize(file.size);
                        const date = new Date(file.modified * 1000).toLocaleString();
                        
                        html += `
                            <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 12px; align-items: center; padding: 12px; background: var(--bg-tertiary); border-radius: 6px; border: 1px solid var(--border);">
                                <div>
                                    <div style="font-weight: 500; color: var(--accent);">üìÑ ${escapeHtml(file.name)}</div>
                                    <div style="font-size: 12px; color: var(--text-muted);">${fileSize} ‚Ä¢ ${date}</div>
                                </div>
                                <a href="${file.url}" download class="btn btn-secondary" style="padding: 6px 12px; width: auto;">
                                    ‚¨áÔ∏è Download
                                </a>
                                <button class="btn btn-danger" style="padding: 6px 12px; width: auto;" onclick="deleteFile('${escapeHtml(file.name)}')">
                                    üóëÔ∏è Delete
                                </button>
                            </div>
                        `;
                    });
                    
                    html += '</div>';
                    filesList.innerHTML = html;
                } else {
                    filesList.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">No files uploaded yet</div>';
                }
            } catch (error) {
                filesList.innerHTML = `<div style="text-align: center; padding: 20px; color: var(--error);">Error loading files: ${error.message}</div>`;
                showToast('Failed to load files', 'error');
            }
        }
        
        async function deleteFile(filename) {
            if (!confirm(`Delete file: ${filename}?`)) return;
            
            try {
                const response = await fetch(`/api/files/${encodeURIComponent(filename)}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    showToast('File deleted successfully', 'success');
                    loadFiles();
                } else {
                    showToast(data.message, 'error');
                }
            } catch (error) {
                showToast('Failed to delete file', 'error');
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }
        
        // Parse ls -la output into file objects
        function parseLsOutput(output, currentPath) {
            const files = [];
            const lines = output.split('\n');
            
            // Strip ANSI escape codes
            const stripAnsi = (str) => str.replace(/\x1B\[[0-9;]*[a-zA-Z]/g, '').replace(/\x1B\].*?\x07/g, '');
            
            for (const line of lines) {
                const cleanLine = stripAnsi(line);
                
                // Skip header, prompt, command echo, and empty lines
                if (cleanLine.trim() === '' || 
                    cleanLine.includes('total') || 
                    cleanLine.includes('$') || 
                    cleanLine.includes('#') || 
                    cleanLine.includes('ls -la') ||
                    cleanLine.includes('ls: ') ||
                    cleanLine.trim().startsWith('%')) {
                    continue;
                }
                
                // Parse ls -la format: drwxr-xr-x 2 user group 4096 Jan 1 12:00 filename
                // Or: drwxr-xr-x 2 user group 4096 Jan 1 2024 filename (for older files)
                const match = cleanLine.trim().match(/^([drwxlsStT\-]{10})\s+(\d+)\s+(\S+)\s+(\S+)\s+(\d+)\s+(\w{3})\s+(\d{1,2})\s+([\d:]+|\d{4})\s+(.+)$/);
                
                if (match) {
                    const permissions = match[1];
                    const size = match[5];
                    const month = match[6];
                    const day = match[7];
                    const timeOrYear = match[8];
                    const name = match[9].trim();
                    
                    // Skip . and ..
                    if (name === '.' || name === '..') continue;
                    
                    const isDir = permissions.startsWith('d');
                    const isLink = permissions.startsWith('l');
                    
                    // For symlinks, extract the actual name (before ' -> ')
                    const displayName = isLink ? name.split(' -> ')[0] : name;
                    const linkTarget = isLink && name.includes(' -> ') ? name.split(' -> ')[1] : null;
                    
                    files.push({
                        name: displayName,
                        linkTarget: linkTarget,
                        permissions: permissions,
                        size: size,
                        date: `${month} ${day} ${timeOrYear}`,
                        isDir: isDir,
                        isLink: isLink,
                        path: currentPath.replace(/\/$/, '') + '/' + displayName
                    });
                }
            }
            return files;
        }
        
        // Render file browser table
        function renderFileBrowser(files, currentPath) {
            const browser = document.getElementById('filesBrowser');
            
            if (!files || files.length === 0) {
                browser.innerHTML = '<div style="text-align: center; padding: 48px; color: var(--text-muted);">Directory is empty or no files found</div>';
                return;
            }
            
            // Sort: directories first, then files alphabetically
            files.sort((a, b) => {
                if (a.isDir && !b.isDir) return -1;
                if (!a.isDir && b.isDir) return 1;
                return a.name.localeCompare(b.name);
            });
            
            let html = `
                <div style="margin-bottom: 12px; padding: 8px 12px; background: var(--bg-tertiary); border-radius: var(--radius-sm); font-family: var(--font-mono); font-size: 12px; color: var(--text-secondary);">
                    ${escapeHtml(currentPath)}
                </div>
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border); text-align: left;">
                            <th style="padding: 12px 8px; font-weight: 600; color: var(--text-primary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Name</th>
                            <th style="padding: 12px 8px; font-weight: 600; color: var(--text-primary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Size</th>
                            <th style="padding: 12px 8px; font-weight: 600; color: var(--text-primary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Permissions</th>
                            <th style="padding: 12px 8px; font-weight: 600; color: var(--text-primary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Modified</th>
                            <th style="padding: 12px 8px; font-weight: 600; color: var(--text-primary); font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Add parent directory link
            const parentPath = currentPath.split('/').slice(0, -1).join('/') || '~';
            html += `
                <tr style="border-bottom: 1px solid var(--border); cursor: pointer;" onclick="navigateToPath('${parentPath}')">
                    <td style="padding: 10px 8px; color: var(--text-muted);">
                        <span style="display: flex; align-items: center; gap: 8px;">
                            <span style="color: var(--accent-bright);">‚Ü©</span> ..
                        </span>
                    </td>
                    <td style="padding: 10px 8px; color: var(--text-muted);">-</td>
                    <td style="padding: 10px 8px; color: var(--text-muted);">-</td>
                    <td style="padding: 10px 8px; color: var(--text-muted);">-</td>
                    <td style="padding: 10px 8px;">-</td>
                </tr>
            `;
            
            for (const file of files) {
                const icon = file.isDir ? 'üìÅ' : (file.isLink ? 'üîó' : 'üìÑ');
                const colorStyle = file.isDir ? 'color: var(--accent-bright); cursor: pointer;' : 'color: var(--text-primary);';
                const clickHandler = file.isDir ? `onclick="navigateToPath('${escapeHtml(file.path).replace(/'/g, "\\'")}')"` : '';
                const linkInfo = file.linkTarget ? ` ‚Üí ${escapeHtml(file.linkTarget)}` : '';
                
                html += `
                    <tr style="border-bottom: 1px solid var(--border);" ${clickHandler}>
                        <td style="padding: 10px 8px; ${colorStyle}">
                            <span style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 14px;">${icon}</span>
                                <span>${escapeHtml(file.name)}</span>
                                ${file.isLink ? `<span style="color: var(--text-muted); font-size: 11px;">${linkInfo}</span>` : ''}
                            </span>
                        </td>
                        <td style="padding: 10px 8px; color: var(--text-secondary); font-family: var(--font-mono); font-size: 12px;">${file.isDir ? '-' : formatFileSize(parseInt(file.size) || 0)}</td>
                        <td style="padding: 10px 8px; color: var(--text-muted); font-family: var(--font-mono); font-size: 11px;">${file.permissions}</td>
                        <td style="padding: 10px 8px; color: var(--text-muted); font-size: 12px;">${file.date}</td>
                        <td style="padding: 10px 8px;">
                            ${!file.isDir ? `<button class="btn btn-secondary" onclick="event.stopPropagation(); viewFile('${escapeHtml(file.path).replace(/'/g, "\\'")}')" style="font-size: 11px; padding: 4px 10px;">View</button>` : ''}
                        </td>
                    </tr>
                `;
            }
            
            html += '</tbody></table>';
            browser.innerHTML = html;
        }
        
        // Navigate to path in file browser
        function navigateToPath(path) {
            document.getElementById('browsePath').value = path;
            browseDirectory();
        }
        
        // View file content
        function viewFile(path) {
            document.getElementById('viewFilePath').value = path;
            viewFileContent();
        }
        
        // Enhanced File Management Functions
        async function browseDirectory() {
            const path = document.getElementById('browsePath').value.trim() || '~';
            const browser = document.getElementById('filesBrowser');
            
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                browser.innerHTML = '<div style="text-align: center; padding: 48px; color: var(--text-muted);">Connect to SSH to browse files</div>';
                showToast('Not connected to SSH', 'error');
                return;
            }
            
            browser.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-secondary);">Loading...</div>';
            
            runCommandSilent(`ls -la ${path}`, (output) => {
                const files = parseLsOutput(output, path);
                renderFileBrowser(files, path);
                showToast(`Found ${files.length} items in ${path}`, 'success');
            });
        }
        
        async function browseHome() {
            document.getElementById('browsePath').value = '~';
            browseDirectory();
        }
        
        let browseFilesPanelCollapsed = false;
        function toggleBrowseFilesPanel() {
            browseFilesPanelCollapsed = !browseFilesPanelCollapsed;
            const panelBody = document.getElementById('browseFilesPanelBody');
            const icon = document.getElementById('browseFilesPanelIcon');
            panelBody.style.display = browseFilesPanelCollapsed ? 'none' : 'block';
            icon.style.transform = browseFilesPanelCollapsed ? 'rotate(-90deg)' : 'rotate(0deg)';
        }
        
        async function uploadFileToRemote() {
            const fileInput = document.getElementById('fileInput');
            const remotePath = document.getElementById('uploadRemotePath').value.trim();
            const statusDiv = document.getElementById('uploadStatus');
            
            if (!fileInput.files.length) {
                statusDiv.textContent = '‚ùå Please select a file';
                statusDiv.style.color = 'var(--error)';
                return;
            }
            
            if (!remotePath) {
                statusDiv.textContent = '‚ùå Please enter remote path';
                statusDiv.style.color = 'var(--error)';
                return;
            }
            
            statusDiv.textContent = '‚è≥ Uploading to remote server...';
            statusDiv.style.color = 'var(--warning)';
            
            const file = fileInput.files[0];
            showToast(`Uploading ${file.name} to ${remotePath}`, 'success');
            
            // This would require backend implementation with SCP
            statusDiv.textContent = '‚ö†Ô∏è Use terminal: scp local_file user@host:remote_path';
            statusDiv.style.color = 'var(--warning)';
        }
        
        async function downloadFile() {
            const remotePath = document.getElementById('downloadRemotePath').value.trim();
            const statusDiv = document.getElementById('downloadStatus');
            
            if (!remotePath) {
                statusDiv.textContent = '‚ùå Please enter remote file path';
                statusDiv.style.color = 'var(--error)';
                return;
            }
            
            statusDiv.textContent = '‚è≥ Downloading...';
            statusDiv.style.color = 'var(--warning)';
            
            showToast(`Download initiated for ${remotePath}`, 'success');
            
            // This would require backend implementation with SCP
            statusDiv.textContent = '‚ö†Ô∏è Use terminal: scp user@host:remote_file local_path';
            statusDiv.style.color = 'var(--warning)';
        }
        
        async function searchFiles() {
            const path = document.getElementById('searchPath').value.trim() || '~';
            const pattern = document.getElementById('searchPattern').value.trim();
            const depthOnly = document.getElementById('searchDepth').checked;
            
            if (!pattern) {
                showToast('Please enter a search pattern', 'error');
                return;
            }
            
            let cmd;
            if (depthOnly) {
                cmd = `find ${path} -maxdepth 1 -name "*${pattern}*" | head -50`;
            } else {
                cmd = `find ${path} -name "*${pattern}*" | head -50`;
            }
            
            runCommand(cmd);
            showToast(`Searching for "${pattern}" in ${path}`, 'success');
        }
        
        async function viewFileContent() {
            const filePath = document.getElementById('viewFilePath').value.trim();
            const lines = document.getElementById('viewLines').value || 50;
            
            if (!filePath) {
                showToast('Please enter a file path', 'error');
                return;
            }
            
            const cmd = `head -n ${lines} ${filePath}`;
            runCommand(cmd);
            showToast(`Viewing ${filePath} (${lines} lines)`, 'success');
            
            // Show file content viewer
            document.getElementById('fileContentViewer').style.display = 'block';
            document.getElementById('fileContentTitle').textContent = `üìÑ ${filePath}`;
        }
        
        function closeFileViewer() {
            document.getElementById('fileContentViewer').style.display = 'none';
        }
        
        async function createDirectory() {
            const path = document.getElementById('createDirPath').value.trim();
            
            if (!path) {
                showToast('Please enter a directory path', 'error');
                return;
            }
            
            const cmd = `mkdir -p ${path} && echo "‚úì Directory created: ${path}"`;
            runCommand(cmd);
            showToast(`Creating directory: ${path}`, 'success');
        }
        
        async function deleteFileOrDir() {
            const path = document.getElementById('deletePath').value.trim();
            const isDir = document.getElementById('deleteIsDir').checked;
            
            if (!path) {
                showToast('Please enter a path', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete: ${path}?`)) {
                return;
            }
            
            const cmd = isDir 
                ? `rm -rf ${path} && echo "‚úì Deleted: ${path}"`
                : `rm ${path} && echo "‚úì Deleted: ${path}"`;
            
            runCommand(cmd);
            showToast(`Deleting: ${path}`, 'success');
        }
        
        async function renameFile() {
            const oldPath = document.getElementById('renameOldPath').value.trim();
            const newPath = document.getElementById('renameNewPath').value.trim();
            
            if (!oldPath || !newPath) {
                showToast('Please enter both old and new paths', 'error');
                return;
            }
            
            const cmd = `mv ${oldPath} ${newPath} && echo "‚úì Renamed: ${oldPath} ‚Üí ${newPath}"`;
            runCommand(cmd);
            showToast(`Renaming: ${oldPath} ‚Üí ${newPath}`, 'success');
        }
        
        async function editFile() {
            const filePath = document.getElementById('editFilePath').value.trim() || '~/';
            const fileName = document.getElementById('editFileName').value.trim();
            
            if (!fileName) {
                showToast('Please enter a file name', 'error');
                return;
            }
            
            // Make sure terminal is visible
            if (terminalCollapsed) {
                toggleTerminal();
            }
            switchTerminalMode('shell');
            
            const cmd = `nano ${filePath}/${fileName}`;
            runCommand(cmd);
            showToast('Opening nano editor...', 'success');
        }
        
        async function checkDiskQuota() {
            const path = document.getElementById('diskQuotaPath').value.trim() || '~';
            
            runCommand(`du -h ${path} | sort -hr | head -20`);
            
            setTimeout(() => {
                runCommand('lfs quota -h ~/');
            }, 1000);
            
            showToast(`Checking disk usage for ${path}`, 'success');
        }
        
        // SLURM Dashboard Functions - Parse from Terminal Output
        let dashboardRefreshInterval = null;
        let terminalOutputBuffer = '';
        let pendingCommand = null;
        let commandCallbacks = {};
        
        // Enhanced message handler to capture and parse output
        function setupOutputParser() {
            // Store original onmessage if exists
            const originalOnMessage = ws ? ws.onmessage : null;
            
            if (ws) {
                ws.onmessage = (event) => {
                    const msg = JSON.parse(event.data);
                    if (msg.type === 'output') {
                        term.write(msg.data);
                        
                        // Add to buffer for parsing
                        terminalOutputBuffer += msg.data;
                        
                        // Check if we have a complete output (ends with prompt)
                        if (pendingCommand && (msg.data.includes('$') || msg.data.includes('#') || msg.data.includes('%'))) {
                            const callback = commandCallbacks[pendingCommand];
                            if (callback) {
                                callback(terminalOutputBuffer);
                                delete commandCallbacks[pendingCommand];
                            }
                            pendingCommand = null;
                            terminalOutputBuffer = '';
                        }
                        
                        setTimeout(() => term.scrollToBottom(), 10);
                        
                        if (msg.data.includes('Last login') || msg.data.includes('$') || msg.data.includes('#')) {
                            if (!isConnected) {
                                isConnected = true;
                                updateConnectionStatus(true);
                                logToTerminal(`Connected to ${document.getElementById('user').value}@${document.getElementById('host').value}`, 'ok');
                            }
                        }
                    } else if (msg.type === 'connected') {
                        logToTerminal(`SSH session started`, 'warn');
                    } else if (msg.type === 'error') {
                        term.writeln(`\x1b[31mError: ${msg.data}\x1b[0m`);
                        logToTerminal(msg.data, 'err');
                        setTimeout(() => term.scrollToBottom(), 10);
                    }
                };
            }
        }
        
        // Execute command and capture output
        function executeAndParse(cmd, callback) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                showToast('Not connected. Connect first.', 'error');
                return;
            }
            
            terminalOutputBuffer = '';
            pendingCommand = cmd;
            commandCallbacks[cmd] = callback;
            
            ws.send(JSON.stringify({ type: 'input', data: cmd + '\n' }));
        }
        
        // Parse squeue output
        function parseSqueueOutput(output) {
            const jobs = [];
            const lines = output.split('\n');
            
            for (const line of lines) {
                // Skip header and empty lines
                if (line.includes('JOBID') || line.includes('squeue') || line.trim() === '' || line.includes('$') || line.includes('#')) {
                    continue;
                }
                
                // Parse squeue format: JOBID PARTITION NAME USER ST TIME NODES NODELIST(REASON)
                const parts = line.trim().split(/\s+/);
                if (parts.length >= 7 && /^\d+/.test(parts[0])) {
                    const status = parts[4];
                    let statusColor = 'muted';
                    if (status === 'R' || status === 'RUNNING') statusColor = 'success';
                    else if (status === 'PD' || status === 'PENDING') statusColor = 'warning';
                    else if (status === 'F' || status === 'FAILED') statusColor = 'error';
                    else if (status === 'CG' || status === 'COMPLETING') statusColor = 'info';
                    
                    jobs.push({
                        job_id: parts[0],
                        partition: parts[1],
                        name: parts[2],
                        user: parts[3],
                        status: status === 'R' ? 'RUNNING' : status === 'PD' ? 'PENDING' : status,
                        status_color: statusColor,
                        elapsed_time: parts[5],
                        nodes: parts[6],
                        nodelist: parts[7] || 'N/A',
                        cpus: 'N/A',
                        gpus: '0',
                        reason: parts[7] && parts[7].includes('(') ? parts[7].replace(/[()]/g, '') : ''
                    });
                }
            }
            return jobs;
        }
        
        // Parse sinfo output for nodes
        function parseSinfoOutput(output) {
            const nodes = [];
            const lines = output.split('\n');
            
            for (const line of lines) {
                if (line.includes('NODELIST') || line.includes('sinfo') || line.trim() === '' || line.includes('$') || line.includes('#')) {
                    continue;
                }
                
                // Parse sinfo format: NODELIST PARTITION STATE CPUS MEMORY GRES
                const parts = line.trim().split(/\s+/);
                if (parts.length >= 4) {
                    const state = parts[2] || 'unknown';
                    let stateColor = 'warning';
                    if (state.includes('idle')) stateColor = 'success';
                    else if (state.includes('alloc') || state.includes('mix')) stateColor = 'info';
                    else if (state.includes('down') || state.includes('drain')) stateColor = 'error';
                    
                    nodes.push({
                        name: parts[0],
                        partition: parts[1],
                        state: state,
                        state_color: stateColor,
                        cpus: parts[3] || 'N/A',
                        memory: parts[4] || 'N/A',
                        gpus: parts[5] && parts[5].includes('gpu') ? parts[5].split(':')[1] || '0' : '0'
                    });
                }
            }
            return nodes;
        }
        
        // Parse GPU info from sinfo
        function parseGpuInfo(output) {
            const gpuNodes = [];
            const lines = output.split('\n');
            
            for (const line of lines) {
                if (line.includes('NODELIST') || line.includes('sinfo') || line.trim() === '' || line.includes('$') || line.includes('#')) {
                    continue;
                }
                
                const parts = line.trim().split(/\s+/);
                if (parts.length >= 3 && parts[2] && parts[2].includes('gpu')) {
                    gpuNodes.push({
                        node: parts[0],
                        partition: parts[1],
                        gpus: parts[2].split(':')[2] || parts[2].split(':')[1] || '1',
                        state: parts[3] || 'unknown'
                    });
                }
            }
            return gpuNodes;
        }
        
        // Load dashboard by running SLURM commands
        async function loadDashboard() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                document.getElementById('totalJobsCount').textContent = '-';
                document.getElementById('runningJobsCount').textContent = '-';
                document.getElementById('pendingJobsCount').textContent = '-';
                document.getElementById('totalNodesCount').textContent = '-';
                document.getElementById('jobsContainer').innerHTML = '<div style="text-align: center; padding: 60px; color: var(--text-muted);">Connect to SSH to load dashboard</div>';
                return;
            }
            
            showToast('Refreshing dashboard...', 'info');
            
            // Run squeue to get jobs
            runCommandSilent('squeue -u $USER --format="%.18i %.9P %.30j %.8u %.2t %.10M %.6D %R"', (output) => {
                const jobs = parseSqueueOutput(output);
                
                // Update stats
                document.getElementById('totalJobsCount').textContent = jobs.length;
                document.getElementById('runningJobsCount').textContent = jobs.filter(j => j.status === 'RUNNING').length;
                document.getElementById('pendingJobsCount').textContent = jobs.filter(j => j.status === 'PENDING').length;
                
                // Render jobs
                renderJobCards(jobs);
            });
            
            // Run sinfo to get nodes
            runCommandSilent('sinfo --format="%.20N %.10P %.10t %.4c %.10m %.10G"', (output) => {
                const nodes = parseSinfoOutput(output);
                document.getElementById('totalNodesCount').textContent = nodes.length;
                renderNodesTable(nodes);
            });
            
            // Run sinfo for GPU info
            runCommandSilent('sinfo -o "%N %P %G %t" --noheader | grep gpu', (output) => {
                const gpuInfo = parseGpuInfo(output);
                renderGpuInfo(gpuInfo);
            });
        }
        
        // Run command silently (don't switch to terminal view)
        function runCommandSilent(cmd, callback) {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                return;
            }
            
            // Create unique command ID
            const cmdId = cmd + '_' + Date.now();
            let outputBuffer = '';
            let timeoutId = null;
            
            // Store original handler
            const originalHandler = ws.onmessage;
            
            // Temporary handler to capture output
            const captureOutput = (event) => {
                const msg = JSON.parse(event.data);
                if (msg.type === 'output') {
                    term.write(msg.data);
                    outputBuffer += msg.data;
                    
                    // Reset timeout on each output
                    if (timeoutId) clearTimeout(timeoutId);
                    
                    // Check if command completed (prompt appeared)
                    if (msg.data.includes('$') || msg.data.includes('#') || msg.data.includes('%')) {
                        ws.onmessage = originalHandler;
                        if (callback) callback(outputBuffer);
                    } else {
                        // Set timeout in case prompt not detected
                        timeoutId = setTimeout(() => {
                            ws.onmessage = originalHandler;
                            if (callback) callback(outputBuffer);
                        }, 2000);
                    }
                    
                    setTimeout(() => term.scrollToBottom(), 10);
                } else {
                    // Handle other message types normally
                    if (originalHandler) originalHandler(event);
                }
            };
            
            ws.onmessage = captureOutput;
            ws.send(JSON.stringify({ type: 'input', data: cmd + '\n' }));
        }
        
        function renderJobCards(jobs) {
            const container = document.getElementById('jobsContainer');
            
            if (!jobs || jobs.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 60px; color: var(--text-muted);">No active jobs found</div>';
                return;
            }
            
            container.innerHTML = jobs.map(job => `
                <div class="job-card">
                    <div class="job-status-badge ${job.status_color}">
                        ${job.status.substring(0, 3)}
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px; flex: 1;">
                        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                            <h3 style="margin: 0; color: var(--accent-bright); font-size: 16px;">Job #${job.job_id}</h3>
                            <span style="color: var(--text-secondary); font-size: 14px;">${escapeHtml(job.name)}</span>
                            <span style="display: inline-block; padding: 4px 10px; background: var(--bg-tertiary); border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 12px; color: var(--text-secondary); font-weight: 500;">
                                ${job.status}
                            </span>
                        </div>
                        <div class="job-info">
                            <div class="job-info-item">
                                <label>Partition</label>
                                <value>${escapeHtml(job.partition)}</value>
                            </div>
                            <div class="job-info-item">
                                <label>Nodes</label>
                                <value>${escapeHtml(job.nodes)}</value>
                            </div>
                            <div class="job-info-item">
                                <label>Time</label>
                                <value>${job.elapsed_time || 'N/A'}</value>
                            </div>
                            <div class="job-info-item">
                                <label>Node List</label>
                                <value>${escapeHtml(job.nodelist)}</value>
                            </div>
                            ${job.reason ? `
                            <div class="job-info-item">
                                <label>Reason</label>
                                <value style="color: var(--warning); font-size: 12px;">${escapeHtml(job.reason)}</value>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                    <div class="job-actions">
                        <button class="btn btn-secondary" onclick="jobDetailInfo('${job.job_id}')" style="font-size: 12px; padding: 8px 12px;">Details</button>
                        <button class="btn btn-danger" onclick="quickCancel('${job.job_id}')" style="font-size: 12px; padding: 8px 12px;">Cancel</button>
                    </div>
                </div>
            `).join('');
        }
        
        function renderNodesTable(nodes) {
            const tbody = document.getElementById('nodesTableBody');
            
            if (!nodes || nodes.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: var(--text-muted);">No nodes available</td></tr>';
                return;
            }
            
            tbody.innerHTML = nodes.map(node => `
                <tr style="border-bottom: 1px solid var(--border);">
                    <td style="padding: 14px 16px; color: var(--text-primary); font-weight: 500;">${escapeHtml(node.name)}</td>
                    <td style="padding: 14px 16px;">
                        <span style="padding: 4px 10px; border-radius: var(--radius-sm); font-size: 12px; font-weight: 500; background: ${node.state_color === 'success' ? 'rgba(34, 197, 94, 0.15)' : node.state_color === 'info' ? 'rgba(59, 130, 246, 0.15)' : 'rgba(245, 158, 11, 0.15)'}; color: ${node.state_color === 'success' ? 'var(--success)' : node.state_color === 'info' ? 'var(--accent-bright)' : 'var(--warning)'};">
                            ${node.state}
                        </span>
                    </td>
                    <td style="padding: 14px 16px; color: var(--text-secondary);">${node.cpus}</td>
                    <td style="padding: 14px 16px; color: var(--text-secondary);">${node.memory}</td>
                    <td style="padding: 14px 16px; color: ${node.gpus !== '0' ? 'var(--accent-bright)' : 'var(--text-muted)'};">${node.gpus !== '0' ? `${node.gpus} GPU(s)` : 'None'}</td>
                </tr>
            `).join('');
        }
        
        function renderGpuInfo(gpuInfo) {
            const container = document.getElementById('gpuContainer');
            
            if (!gpuInfo || gpuInfo.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 60px; color: var(--text-muted);">No GPU nodes found or GPU info unavailable</div>';
                return;
            }
            
            container.innerHTML = gpuInfo.map(gpu => `
                <div class="card" style="display: grid; grid-template-columns: auto 1fr; gap: 20px; align-items: center;">
                    <div style="width: 56px; height: 56px; background: var(--accent); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center;">
                        <span style="font-size: 24px; filter: grayscale(1) brightness(2);">üéÆ</span>
                    </div>
                    <div>
                        <h4 style="margin: 0 0 12px 0; color: var(--text-primary); font-size: 16px;">${escapeHtml(gpu.node)}</h4>
                        <div style="display: flex; gap: 24px; font-size: 13px;">
                            <div>
                                <span style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">Partition</span>
                                <div style="color: var(--text-primary); font-weight: 600; margin-top: 4px;">${escapeHtml(gpu.partition)}</div>
                            </div>
                            <div>
                                <span style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">GPUs</span>
                                <div style="color: var(--accent-bright); font-weight: 600; margin-top: 4px;">${gpu.gpus}</div>
                            </div>
                            <div>
                                <span style="color: var(--text-muted); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px;">State</span>
                                <div style="color: ${gpu.state.includes('idle') ? 'var(--success)' : 'var(--warning)'}; font-weight: 600; margin-top: 4px;">${gpu.state}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function switchDashboardView(view) {
            // Hide all views
            document.querySelectorAll('.dashboard-view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.dashboard-subtab').forEach(t => t.classList.remove('active'));
            
            // Show selected view and mark button active
            document.getElementById(view + '-view').classList.add('active');
            event.target.classList.add('active');
        }
        
        function toggleAutoRefresh() {
            const isChecked = document.getElementById('autoRefresh').checked;
            
            if (isChecked) {
                // Refresh immediately
                loadDashboard();
                // Then every 10 seconds
                dashboardRefreshInterval = setInterval(loadDashboard, 10000);
                showToast('Auto-refresh enabled (10s)', 'success');
            } else {
                if (dashboardRefreshInterval) {
                    clearInterval(dashboardRefreshInterval);
                }
                showToast('Auto-refresh disabled', 'success');
            }
        }
        
        function jobDetailInfo(jobId) {
            document.getElementById('jobIdInfo').value = jobId;
            jobInfo();
        }
        
        function quickCancel(jobId) {
            if (confirm(`Cancel job ${jobId}?`)) {
                document.getElementById('jobIdCancel').value = jobId;
                cancelJob();
            }
        }
        
        // Initial load when page opens
        document.addEventListener('DOMContentLoaded', () => {
            loadProfiles();
        });
    </script>
</body>
</html>